<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BacBo Analyzer ‚Äî ProCode++ Omega (Modo Cont√≠nuo)</title>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0a1217;
  color: #e8f9f3;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px;
}
h1 { color: #00ffc3; margin-bottom: 10px; }
#panel {
  background: #0e1a20;
  border-radius: 10px;
  padding: 12px;
  width: 90%;
  max-width: 900px;
}
button {
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  margin: 4px;
  cursor: pointer;
  font-size: 14px;
}
button.primary { background: #00ffc3; color: #000; font-weight: bold; }
button.alt { background: #18252b; color: #fff; }
canvas { border-radius: 10px; margin-top: 8px; max-width: 90%; }
#results { display: flex; justify-content: center; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
#stats { margin-top: 10px; font-size: 14px; color: #8ff; }
#log { font-size: 13px; color: #ccc; margin-top: 10px; max-height: 150px; overflow-y: auto; background:#091216; padding:5px; border-radius:8px; }
#intervalSet { margin-top: 10px; }
</style>
</head>
<body>
<h1>üîÆ BacBo Analyzer ‚Äî ProCode++ Omega (Modo Cont√≠nuo)</h1>

<div>
  <button id="sendImg" class="alt">üì∏ Enviar Gr√°fico</button>
  <button id="toggleAuto" class="primary">‚ñ∂Ô∏è Iniciar Auto An√°lise</button>
  <button id="stopBtn" class="alt">‚õî Parar</button>
</div>

<canvas id="canvas"></canvas>
<canvas id="overlay"></canvas>

<div id="panel">
  <div><b>Status:</b> <span id="status">Aguardando imagem...</span></div>
  <div><b>Padr√£o:</b> <span id="pattern">‚Äî</span></div>
  <div><b>Confian√ßa:</b> <span id="conf">0%</span></div>
  <div><b>Recomenda√ß√£o:</b> <span id="nextRec">‚Äî</span></div>

  <div id="intervalSet">
    <label>Intervalo (segundos): </label>
    <input type="number" id="intervalInput" value="5" min="2" max="60" style="width:60px;text-align:center;">
  </div>

  <div id="results">
    <button id="btnAcertou" style="background:#00ff66">‚úÖ Acertou</button>
    <button id="btnErrou" style="background:#ff3366">‚ùå Errou</button>
    <button id="btnEmpate" style="background:#ffcc00">‚öñÔ∏è Empatou</button>
  </div>

  <div id="stats">Hist√≥rico: 0 acertos / 0 erros / 0 empates (0%)</div>
  <div id="log"></div>
</div>

<script>
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const overlay=document.getElementById('overlay');
const octx=overlay.getContext('2d');
const statusEl=document.getElementById('status');
const patternEl=document.getElementById('pattern');
const confEl=document.getElementById('conf');
const nextRecEl=document.getElementById('nextRec');
const statsEl=document.getElementById('stats');
const logEl=document.getElementById('log');
const intervalInput=document.getElementById('intervalInput');

let acertos=0,erros=0,empates=0;
let weights={player:1,banker:1,tie:1};
let lastRecommendation="‚Äî";
let autoRunning=false,autoTimer=null;

function resizeCanvas(w,h){canvas.width=w;canvas.height=h;overlay.width=w;overlay.height=h;}

function colorRole(r,g,b){
  if(r>170&&g<90&&b<90)return"banker"; // vermelho
  if(b>150&&r<100&&g<120)return"player"; // azul
  if(r>180&&g>180&&b<100)return"tie"; // amarelo
  return null;
}

function detect(frame,w,h){
  const data=frame.data,points=[],step=6;
  for(let y=0;y<h;y+=step){
    for(let x=0;x<w;x+=step){
      const i=(y*w+x)*4;
      const role=colorRole(data[i],data[i+1],data[i+2]);
      if(role)points.push({x,y,role});
    }
  }
  const clusters=[];
  const dist=10;
  points.forEach(p=>{
    let f=clusters.find(c=>Math.hypot(c.x-p.x,c.y-p.y)<dist&&c.role===p.role);
    if(f){f.x=(f.x*f.n+p.x)/(f.n+1);f.y=(f.y*f.n+p.y)/(f.n+1);f.n++;}
    else clusters.push({x:p.x,y:p.y,role:p.role,n:1});
  });
  return clusters;
}

function analyze(blobs){
  const seq=blobs.map(b=>b.role);
  if(seq.length===0)return{name:"Sem padr√£o vis√≠vel",conf:0};
  const s=seq.join("-");
  if(/(player-){3,}/.test(s))return{name:"Dom√≠nio Player",conf:0.9};
  if(/(banker-){3,}/.test(s))return{name:"Dom√≠nio Banker",conf:0.9};
  if(seq.every((x,i,a)=>i===0||x!==a[i-1]))return{name:"Altern√¢ncia",conf:0.85};
  if(seq.includes("tie"))return{name:"Empates frequentes",conf:0.7};
  return{name:"Padr√£o neutro",conf:0.55};
}

function predictNext(){
  const entries=Object.entries(weights);
  const rec=entries.reduce((a,b)=>a[1]>b[1]?a:b)[0];
  return rec;
}

function updateStats(){
  const total=acertos+erros+empates;
  const perc=total?Math.round(acertos/total*100):0;
  statsEl.innerText=`Hist√≥rico: ${acertos} acertos / ${erros} erros / ${empates} empates (${perc}%)`;
}

function registrar(tipo){
  if(tipo==="acerto"){acertos++;weights[lastRecommendation]++;}
  if(tipo==="erro"){erros++;weights[lastRecommendation]=Math.max(1,weights[lastRecommendation]-1);}
  if(tipo==="empate"){empates++;weights["tie"]++;}
  updateStats();
  analyzeCurrentImage(); // reanalisar e recomendar
}

function drawOverlay(blobs){
  octx.clearRect(0,0,overlay.width,overlay.height);
  blobs.forEach(b=>{
    octx.beginPath();
    octx.arc(b.x,b.y,8,0,Math.PI*2);
    octx.strokeStyle=b.role==="player"?"#00ffc3":b.role==="banker"?"#ff3366":"#ffff66";
    octx.lineWidth=2;
    octx.stroke();
  });
}

function log(msg){const t=new Date().toLocaleTimeString();logEl.innerHTML=`[${t}] ${msg}<br>`+logEl.innerHTML;}

function analyzeCurrentImage(){
  if(!canvas.width)return;
  const frame=ctx.getImageData(0,0,canvas.width,canvas.height);
  const blobs=detect(frame,canvas.width,canvas.height);
  drawOverlay(blobs);
  const p=analyze(blobs);
  patternEl.innerText=p.name;
  confEl.innerText=Math.round(p.conf*100)+"%";
  const rec=predictNext();
  nextRecEl.innerText=rec==="player"?"üîµ Player":rec==="banker"?"üî¥ Banker":"üü° Empate";
  lastRecommendation=rec;
  log(`Padr√£o: ${p.name} | Recomenda√ß√£o: ${lastRecommendation}`);
  statusEl.innerText="Analisando imagem...";
}

function startAutoAnalysis(){
  if(autoRunning)return;
  const interval=Number(intervalInput.value)*1000;
  autoTimer=setInterval(()=>{analyzeCurrentImage();},interval);
  autoRunning=true;
  statusEl.innerText=`An√°lise cont√≠nua ativa (${interval/1000}s)`;
  log("An√°lise cont√≠nua iniciada.");
}

function stopAutoAnalysis(){
  if(autoTimer){clearInterval(autoTimer);}
  autoRunning=false;
  statusEl.innerText="Parado";
  log("An√°lise cont√≠nua parada.");
}

// --- Eventos ---
document.getElementById('sendImg').onclick=()=>{
  const input=document.createElement('input');
  input.type='file';
  input.accept='image/*';
  input.onchange=e=>{
    const file=e.target.files[0];
    if(!file)return;
    const img=new Image();
    img.onload=()=>{
      resizeCanvas(img.width,img.height);
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      analyzeCurrentImage();
    };
    img.src=URL.createObjectURL(file);
  };
  input.click();
};

document.getElementById('btnAcertou').onclick=()=>registrar("acerto");
document.getElementById('btnErrou').onclick=()=>registrar("erro");
document.getElementById('btnEmpate').onclick=()=>registrar("empate");
document.getElementById('toggleAuto').onclick=()=>autoRunning?stopAutoAnalysis():startAutoAnalysis();
document.getElementById('stopBtn').onclick=stopAutoAnalysis;
</script>
</body>
</html>
