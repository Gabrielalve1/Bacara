
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BacBo Pattern Reader ‚Äî ProCode++ Omega (OCR + Anal√≠tica)</title>
<style>
:root{--bg:#06111a;--card:#0d1b22;--accent:#00ffb3;--muted:#9fb3b3}
body{margin:0;background:var(--bg);color:#e6fbf5;font-family:Inter,Segoe UI,Arial,sans-serif;display:flex;flex-direction:column;align-items:center;padding:14px}
h1{margin:6px 0 10px;color:var(--accent)}
.layout{width:100%;max-width:1100px;display:grid;grid-template-columns:420px 1fr;gap:12px}
.card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.5)}
.controls > *{margin:6px 0;display:flex;gap:8px;align-items:center}
input[type=file]{color:transparent}
button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.muted{color:var(--muted);font-size:13px}
textarea{width:100%;height:80px;background:#081216;border:1px solid #073036;color:#e6fbf5;padding:8px;border-radius:8px}
.hist-list{max-height:420px;overflow:auto;padding:6px;display:flex;flex-wrap:wrap;gap:6px}
.chip{background:#06282a;padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.03);min-width:40px;text-align:center}
.recommend{font-size:18px;color:#001a12;background:var(--accent);padding:10px;border-radius:8px;font-weight:800}
pre{white-space:pre-wrap;color:#dffbf0}
small{color:var(--muted)}
.row{display:flex;gap:8px;align-items:center}
.keyval{display:flex;justify-content:space-between;gap:10px}
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
</head>
<body>
<h1>üîé BacBo Pattern Reader ‚Äî OCR + Anal√≠tica</h1>

<div class="layout">
  <div class="card">
    <div class="controls">
      <div><small>Upload da foto do gr√°fico (boa resolu√ß√£o):</small></div>
      <div>
        <input id="fileInput" type="file" accept="image/*">
        <button id="doOCR">Extrair N√∫meros (OCR)</button>
      </div>
      <div><small class="muted">Ou cole a sequ√™ncia manualmente (se preferir)</small></div>
      <textarea id="manualInput" placeholder="ex: 9,10,8,11,9,10,7,8,11"></textarea>
      <div class="row">
        <input id="singleNum" type="number" min="3" max="18" placeholder="N√∫mero da rodada" style="width:140px;padding:8px;border-radius:6px;border:1px solid #073036;background:#081216;color:#e6fbf5">
        <button id="addRound">‚ûï Adicionar rodada</button>
        <button id="analyzeNow">üîÅ Analisar Agora</button>
      </div>
      <hr style="border:none;border-top:1px solid rgba(255,255,255,.03);margin:8px 0">
      <div class="row">
        <button id="btnAcertou" style="background:#00c37a">‚úÖ Acertou</button>
        <button id="btnErrou" style="background:#ff4d6d">‚ùå Errou</button>
        <button id="btnEmpate" style="background:#ffd166">‚öñÔ∏è Empate</button>
        <button id="resetAll" style="background:#33444a;color:#fff">‚ôªÔ∏è Reset</button>
      </div>
      <hr style="border:none;border-top:1px solid rgba(255,255,255,.03);margin:8px 0">
      <div><small class="muted">Status OCR / Mensagens:</small></div>
      <pre id="log" style="height:90px;overflow:auto;background:#071618;border-radius:6px;padding:8px;font-size:13px"></pre>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="keyval"><div><small class="muted">Tend√™ncia atual</small><div id="trend" style="font-weight:800;margin-top:6px">‚Äî</div></div>
        <div style="margin-top:10px"><small class="muted">Pr√≥xima Recomenda√ß√£o</small><div id="recommendation" class="recommend" style="margin-top:6px">‚Äî</div></div></div>
      <div style="min-width:220px;text-align:right">
        <div><small class="muted">Confian√ßa</small><div id="confidence" style="font-weight:800;margin-top:6px">‚Äî</div></div>
        <div style="margin-top:10px"><small class="muted">Performance</small><div id="performance" style="font-weight:800;margin-top:6px">0 / 0 (‚Äî)</div></div>
      </div>
    </div>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,.03);margin:10px 0">

    <div style="display:flex;gap:12px">
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><small class="muted">Hist√≥rico (√∫ltimos)</small></div>
          <div><small class="muted">N√≠vel de sinal</small></div>
        </div>
        <div id="history" class="hist-list" style="margin-top:8px"></div>
      </div>
      <div style="width:360px">
        <div><small class="muted">Explica√ß√£o da recomenda√ß√£o</small></div>
        <pre id="explanation" style="height:260px;overflow:auto;background:#071618;border-radius:6px;padding:8px"></pre>
      </div>
    </div>
  </div>
</div>

<script>
const logEl = document.getElementById('log');
const historyEl = document.getElementById('history');
const recommendationEl = document.getElementById('recommendation');
const confidenceEl = document.getElementById('confidence');
const explanationEl = document.getElementById('explanation');
const trendEl = document.getElementById('trend');
const performanceEl = document.getElementById('performance');

let sequence = [];
let totalAttempts = 0, totalHits = 0;
let weights = { freq:1.0, recency:1.0, transition:1.4, ngram:1.2, run:1.0 };
const combCounts = {3:1,4:3,5:6,6:10,7:15,8:21,9:25,10:27,11:27,12:25,13:21,14:15,15:10,16:6,17:3,18:1};
const totalComb = 216;

function expectedFreq(n, windowSize){ return (combCounts[n]||0)*(windowSize/totalComb); }
function log(msg){ logEl.textContent += msg+"\n"; logEl.scrollTop = logEl.scrollHeight; }

// ---------- OCR ----------
document.getElementById('doOCR').onclick = async ()=>{
  const file = document.getElementById('fileInput').files[0];
  if(!file){ alert('Escolha uma imagem primeiro'); return; }
  log('OCR: iniciando...');
  try{
    const { data:{text} } = await Tesseract.recognize(file,'por');
    log('OCR: texto extra√≠do: '+text.slice(0,300)+(text.length>300?'...':''));
    const nums = Array.from(text.matchAll(/\b([3-9]|1[0-8])\b/g)).map(m=>parseInt(m[1]));
    if(nums.length){ document.getElementById('manualInput').value = nums.join(', '); log('N√∫meros detectados: '+nums.join(', ')); alert('N√∫meros extra√≠dos!'); }
    else{ log('OCR: nenhum n√∫mero confi√°vel'); alert('OCR n√£o identificou n√∫meros confi√°veis.'); }
  }catch(e){ console.error(e); log('OCR erro: '+e.message); alert('Erro no OCR, veja console'); }
};

// ---------- Utilities ----------
function pushFromManual(){
  const text = document.getElementById('manualInput').value.trim();
  if(!text) return;
  const arr = text.split(/[,;\s]+/).map(s=>parseInt(s)).filter(n=>!isNaN(n)&&n>=3&&n<=18);
  if(!arr.length){ alert('Nenhum n√∫mero v√°lido'); return; }
  sequence = sequence.concat(arr).slice(-200);
  renderAll();
}

document.getElementById('analyzeNow').onclick = ()=>{ pushFromManual(); analyzeAndRecommend(); };
document.getElementById('addRound').onclick = ()=>{
  const val = parseInt(document.getElementById('singleNum').value);
  if(!val || val<3 || val>18){ alert('N√∫mero inv√°lido'); return; }
  sequence.push(val); document.getElementById('singleNum').value=''; sequence = sequence.slice(-200);
  renderAll(); analyzeAndRecommend();
};

document.getElementById('resetAll').onclick = ()=>{
  if(!confirm('Resetar hist√≥rico e aprendizado?')) return;
  sequence=[]; totalAttempts=0; totalHits=0; weights={ freq:1.0, recency:1.0, transition:1.4, ngram:1.2, run:1.0 };
  renderAll(); analyzeAndRecommend();
};

// ---------- Feedback centralizado ----------
function recordFeedbackVal(v){
  if(v==='acerto' || v===true) recordHit();
  else if(v==='errou' || v===false) recordMiss();
  else if(v==='empate') recordTie();
  else console.warn('Feedback inv√°lido:', v);
}

function feedbackAndNext(v){
  recordFeedbackVal(v);
  analyzeAndRecommend();
}

document.getElementById('btnAcertou').onclick = ()=>feedbackAndNext('acerto');
document.getElementById('btnErrou').onclick = ()=>feedbackAndNext('errou');
document.getElementById('btnEmpate').onclick = ()=>feedbackAndNext('empate');

function recordHit(){ totalHits++; totalAttempts++; adjustWeights(1); renderAll(); }
function recordMiss(){ totalAttempts++; adjustWeights(-1); renderAll(); }
function recordTie(){ adjustWeights(0.2); renderAll(); }
function adjustWeights(factor){ for(let k in weights) weights[k] *= (1+0.03*factor); }

// ---------- Render ----------
function renderAll(){
  // hist√≥rico
  historyEl.innerHTML = '';
  sequence.slice(-50).forEach(n=>{
    const chip = document.createElement('div'); chip.className='chip'; chip.textContent=n; historyEl.appendChild(chip);
  });
  // performance
  const perc = totalAttempts?Math.round(100*totalHits/totalAttempts):0;
  performanceEl.textContent = `${totalHits} / ${totalAttempts} (${perc}%)`;
}

// ---------- An√°lise e Recomenda√ß√£o ----------
function analyzeAndRecommend(){
  if(!sequence.length){ recommendationEl.textContent='‚Äî'; confidenceEl.textContent='‚Äî'; explanationEl.textContent='Sequ√™ncia vazia'; trendEl.textContent='‚Äî'; return; }

  // 1. Frequ√™ncia simples
  const freqMap = {}; sequence.forEach(n=>freqMap[n]=(freqMap[n]||0)+1);

  // 2. √öltimos 5 rodadas (rec√™ncia)
  const last5 = sequence.slice(-5); const recMap={}; last5.forEach(n=>recMap[n]=(recMap[n]||0)+1);

  // 3. Transi√ß√£o (√∫ltimo para pr√≥ximo)
  const last = sequence[sequence.length-1]; const transMap={};
  sequence.slice(0,-1).forEach((v,i)=>{ if(sequence[i+1]) transMap[sequence[i+1]]=(transMap[sequence[i+1]]||0)+1; });

  // 4. Ngram simples
  const ngramMap={}; for(let i=0;i<sequence.length-2;i++){ const key=sequence.slice(i,i+2).join(','); const next=sequence[i+2]; ngramMap[next]=(ngramMap[next]||0)+1; }

  // 5. Run (diferen√ßa +1, -1)
  const runMap={}; sequence.slice(1).forEach((v,i)=>{ const diff=v-sequence[i]; runMap[sequence[i]+diff]=(runMap[sequence[i]+diff]||0)+1; });

  // Combina tudo com pesos
  const scores={};
  for(let n=3;n<=18;n++){
    scores[n] = (freqMap[n]||0)*weights.freq
              + (recMap[n]||0)*weights.recency
              + (transMap[n]||0)*weights.transition
              + (ngramMap[n]||0)*weights.ngram
              + (runMap[n]||0)*weights.run;
  }

  const sorted = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
  const top = sorted[0][0]; const topScore=sorted[0][1];
  const totalScore = sorted.reduce((s,[n,v])=>s+v,0);
  const conf = totalScore?Math.round(100*topScore/totalScore):0;

  recommendationEl.textContent=top;
  confidenceEl.textContent=conf+'%';
  explanationEl.textContent=
    'Frequ√™ncia: '+JSON.stringify(freqMap)+'\n'+
    'Rec√™ncia(√∫ltimos 5): '+JSON.stringify(recMap)+'\n'+
    'Transi√ß√£o: '+JSON.stringify(transMap)+'\n'+
    'Ngram: '+JSON.stringify(ngramMap)+'\n'+
    'Run: '+JSON.stringify(runMap)+'\n'+
    'Pesos: '+JSON.stringify(weights);
  
  // Tend√™ncia
  const trend = (last<top)?'Subindo':'Est√°vel/Baixo';
  trendEl.textContent = trend;
}

renderAll();
</script>
</body>
</html>    
