<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BacBo Deep Analyzer ‚Äî Avan√ßado</title>
<style>
:root{--bg:#06111a;--card:#0d1b22;--accent:#00ffb3;--muted:#9fb3b3}
body{margin:0;background:var(--bg);color:#e6fbf5;font-family:Inter,Segoe UI,Arial,sans-serif;display:flex;flex-direction:column;align-items:center;padding:14px}
h1{margin:6px 0 10px;color:var(--accent)}
.layout{width:100%;max-width:1100px;display:grid;grid-template-columns:420px 1fr;gap:12px}
.card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.5)}
.controls > *{margin:6px 0;display:flex;gap:8px;align-items:center}
input[type=file]{color:transparent}
button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.muted{color:var(--muted);font-size:13px}
textarea{width:100%;height:80px;background:#081216;border:1px solid #073036;color:#e6fbf5;padding:8px;border-radius:8px}
.hist-list{max-height:420px;overflow:auto;padding:6px;display:flex;flex-wrap:wrap;gap:6px}
.chip{background:#06282a;padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.03);min-width:40px;text-align:center}
.recommend{font-size:18px;color:#fff;padding:10px;border-radius:8px;font-weight:800;text-align:center}
pre{white-space:pre-wrap;color:#dffbf0}
small{color:var(--muted)}
.row{display:flex;gap:8px;align-items:center}
.keyval{display:flex;justify-content:space-between;gap:10px}
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
</head>
<body>
<h1>üîÆ BacBo Deep Analyzer ‚Äî Ultra Avan√ßado</h1>

<div class="layout">
  <div class="card">
    <div class="controls">
      <div><small>Upload da foto do gr√°fico:</small></div>
      <div>
        <input id="fileInput" type="file" accept="image/*">
        <button id="doOCR">Extrair N√∫meros + Cores</button>
      </div>
      <div><small class="muted">Ou cole a sequ√™ncia manualmente:</small></div>
      <textarea id="manualInput" placeholder="ex: 9,10,8,11,9,10,7,8,11"></textarea>
      <div class="row">
        <button id="analyzeNow">üîÅ Analisar Sequ√™ncia</button>
        <button id="resetAll" style="background:#33444a;color:#fff">‚ôªÔ∏è Resetar Hist√≥rico</button>
      </div>
      <hr style="border:none;border-top:1px solid rgba(255,255,255,.03);margin:8px 0">
      <div><small class="muted">Status / Logs:</small></div>
      <pre id="log" style="height:120px;overflow:auto;background:#071618;border-radius:6px;padding:8px;font-size:13px"></pre>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="keyval"><div><small class="muted">Pr√≥xima Recomenda√ß√£o (3 Estrat√©gias)</small>
          <div id="recommendation" class="recommend" style="margin-top:6px;background:#00ffb3">‚Äî</div>
        </div></div>
      </div>
      <div style="min-width:120px;text-align:right">
        <div><small class="muted">Confian√ßa</small><div id="confidence" style="font-weight:800;margin-top:6px">‚Äî</div></div>
      </div>
    </div>
    <hr style="border:none;border-top:1px solid rgba(255,255,255,.03);margin:10px 0">
    <div><small class="muted">Hist√≥rico Completo</small></div>
    <div id="history" class="hist-list" style="margin-top:8px"></div>
    <hr style="border:none;border-top:1px solid rgba(255,255,255,.03);margin:10px 0">
    <div><small class="muted">Explica√ß√£o Matem√°tica Profunda</small></div>
    <pre id="explanation" style="height:280px;overflow:auto;background:#071618;border-radius:6px;padding:8px"></pre>
  </div>
</div>

<script>
const logEl = document.getElementById('log');
const historyEl = document.getElementById('history');
const recommendationEl = document.getElementById('recommendation');
const confidenceEl = document.getElementById('confidence');
const explanationEl = document.getElementById('explanation');

let sequence = [];
let colors = [];
let weights = { freq:1.2, recency:1.5, transition:1.7, ngram:1.3, run:1.1 };

// ---------- LOG ----------
function log(msg){ logEl.textContent += msg+"\n"; logEl.scrollTop = logEl.scrollHeight; }

// ---------- OCR ----------
document.getElementById('doOCR').onclick = async ()=>{
  const file = document.getElementById('fileInput').files[0];
  if(!file){ alert('Escolha uma imagem'); return; }
  log('OCR: iniciando...');
  try{
    const { data:{text} } = await Tesseract.recognize(file,'por');
    log('OCR: texto extra√≠do: '+text.slice(0,300)+(text.length>300?'...':''));
    const nums = Array.from(text.matchAll(/\b([3-9]|1[0-8])\b/g)).map(m=>parseInt(m[1]));
    if(nums.length){ sequence = nums; renderAll(); alert('OCR: n√∫meros extra√≠dos!'); }
    else{ log('OCR: nenhum n√∫mero confi√°vel'); alert('Erro OCR'); }
    // cores podem ser adicionadas futuramente via canvas pixel analysis
  }catch(e){ log('OCR erro: '+e.message); alert('Erro OCR'); }
};

// ---------- Manual Input ----------
document.getElementById('analyzeNow').onclick = ()=>{
  const text = document.getElementById('manualInput').value.trim();
  if(text){
    const arr = text.split(/[,;\s]+/).map(s=>parseInt(s)).filter(n=>!isNaN(n)&&n>=3&&n<=18);
    if(!arr.length){ alert('Nenhum n√∫mero v√°lido'); return; }
    sequence = arr;
  }
  if(!sequence.length){ alert('Sequ√™ncia vazia'); return; }
  renderAll();
  deepAnalyze();
};

// ---------- Reset ----------
document.getElementById('resetAll').onclick = ()=>{
  if(!confirm('Resetar hist√≥rico completo?')) return;
  sequence=[]; colors=[]; renderAll(); recommendationEl.textContent='‚Äî'; confidenceEl.textContent='‚Äî'; explanationEl.textContent='';
};

// ---------- Render ----------
function renderAll(){
  historyEl.innerHTML='';
  sequence.forEach((n,i)=>{
    const chip=document.createElement('div');
    chip.className='chip';
    chip.textContent=n + (colors[i]?' ('+colors[i]+')':'');
    historyEl.appendChild(chip);
  });
}

// ---------- Deep Analysis ----------
function deepAnalyze(){
  const nmin=3,nmax=18;
  const freqMap={}, recMap={}, transMap={}, ngramMap={}, runMap={};

  // Frequ√™ncia
  sequence.forEach(n=> freqMap[n]=(freqMap[n]||0)+1);

  // Rec√™ncia √∫ltimos 5
  sequence.slice(-5).forEach(n=> recMap[n]=(recMap[n]||0)+1);

  // Transi√ß√µes
  sequence.slice(0,-1).forEach((v,i)=>{
    const next=sequence[i+1];
    transMap[next]=(transMap[next]||0)+1;
  });

  // N-grams (3 e 4)
  for(let size=3; size<=4; size++){
    for(let i=0;i<=sequence.length-size;i++){
      const key = sequence.slice(i,i+size).join(',');
      ngramMap[key]=(ngramMap[key]||0)+1;
    }
  }

  // Runs / diferen√ßas consecutivas
  sequence.slice(1).forEach((v,i)=>{ const diff=v-sequence[i]; runMap[sequence[i]+diff]=(runMap[sequence[i]+diff]||0)+1; });

  // Scores combinados
  const scores={};
  for(let n=nmin;n<=nmax;n++){
    scores[n] = (freqMap[n]||0)*weights.freq
              + (recMap[n]||0)*weights.recency
              + (transMap[n]||0)*weights.transition
              + Object.keys(ngramMap).filter(k=>k.endsWith(n)).length*weights.ngram
              + (runMap[n]||0)*weights.run;
  }

  // Softmax para confian√ßa
  const expScores = Object.values(scores).map(v=>Math.exp(v));
  const sumExp = expScores.reduce((a,b)=>a+b,0);
  const probs = {};
  Object.keys(scores).forEach((k,i)=> probs[k]=Math.round(100*expScores[i]/sumExp));

  // Recomenda√ß√£o top 3 estrat√©gias
  const sorted = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
  const top = sorted.slice(0,3).map(([n,s])=>n);
  recommendationEl.textContent = top.join(' / ');
  confidenceEl.textContent = top.map(n=>probs[n]+'%').join(' / ');

  // Cor da recomenda√ß√£o principal
  const confMain = probs[top[0]]||0;
  if(confMain>70) recommendationEl.style.background='#00c37a';
  else if(confMain>40) recommendationEl.style.background='#ffd700';
  else recommendationEl.style.background='#ff4d6d';

  // Explica√ß√£o detalhada
  explanationEl.textContent=
    '‚úÖ Frequ√™ncia: '+JSON.stringify(freqMap)+'\n'+
    '‚è± Rec√™ncia (√∫ltimos 5): '+JSON.stringify(recMap)+'\n'+
    'üîÄ Transi√ß√µes: '+JSON.stringify(transMap)+'\n'+
    'üî¢ N-grams: '+JSON.stringify(ngramMap)+'\n'+
    'üìà Runs: '+JSON.stringify(runMap)+'\n'+
    'üîß Pesos: '+JSON.stringify(weights)+'\n'+
    'üí° Estrat√©gia combinada: frequ√™ncia + rec√™ncia + transi√ß√µes + runs + n-grams\n'+
    '‚ö° Softmax probabil√≠stico para confian√ßa real';
}

// ---------- Feedback adaptativo ----------
function registerFeedback(isHit){
  const factor=isHit?1.05:0.95;
  Object.keys(weights).forEach(k=> weights[k]*=factor);
  deepAnalyze();
}
</script>
</body>
</html>
