<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BacBo Analyzer ‚Äî ProCode++ Omega X.‚àû Assertivo</title>
<style>
body { margin:0;font-family:Arial,sans-serif;background:#0a1217;color:#e8f9f3;display:flex;flex-direction:column;align-items:center;padding:12px;}
h1 { color:#00ffc3;margin-bottom:10px;}
#panel { background:#0e1a20;border-radius:10px;padding:12px;width:90%;max-width:900px; }
button { border:none;border-radius:8px;padding:8px 12px;margin:4px;cursor:pointer;font-size:14px;}
button.primary { background:#00ffc3;color:#000;font-weight:bold; }
button.alt { background:#18252b;color:#fff;}
canvas { border-radius:10px;margin-top:8px;max-width:90%; }
#results { display:flex;justify-content:center;flex-wrap:wrap;gap:6px;margin-top:10px; }
#stats { margin-top:10px;font-size:14px;color:#8ff; }
#log { font-size:13px;color:#ccc;margin-top:10px;max-height:150px;overflow-y:auto;background:#091216;padding:5px;border-radius:8px; }
#intervalSet { margin-top:10px; }
.predictions { margin-top:6px;font-size:14px;color:#ffcc00;}
</style>
</head>
<body>
<h1>üîÆ BacBo Analyzer ‚Äî Omega X.‚àû Assertivo</h1>

<div>
  <button id="sendImg" class="alt">üì∏ Enviar Gr√°fico</button>
  <button id="toggleAuto" class="primary">‚ñ∂Ô∏è Iniciar Auto An√°lise</button>
  <button id="stopBtn" class="alt">‚õî Parar</button>
</div>

<canvas id="canvas"></canvas>
<canvas id="overlay"></canvas>

<div id="panel">
  <div><b>Status:</b> <span id="status">Aguardando imagem...</span></div>
  <div><b>Padr√£o:</b> <span id="pattern">‚Äî</span></div>
  <div><b>Confian√ßa:</b> <span id="conf">0%</span></div>
  <div><b>Recomenda√ß√£o:</b> <span id="nextRec">‚Äî</span></div>
  <div class="predictions"><b>Pr√≥ximos 3:</b> <span id="next3">‚Äî</span></div>

  <div id="intervalSet">
    <label>Intervalo (segundos): </label>
    <input type="number" id="intervalInput" value="5" min="2" max="60" style="width:60px;text-align:center;">
  </div>

  <div id="results">
    <button id="btnAcertou" style="background:#00ff66">‚úÖ Acertou</button>
    <button id="btnErrou" style="background:#ff3366">‚ùå Errou</button>
    <button id="btnEmpate" style="background:#ffcc00">‚öñÔ∏è Empatou</button>
  </div>

  <div id="stats">Hist√≥rico: 0 acertos / 0 erros / 0 empates (0%)</div>
  <div id="log"></div>
</div>

<script>
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const overlay=document.getElementById('overlay');
const octx=overlay.getContext('2d');
const statusEl=document.getElementById('status');
const patternEl=document.getElementById('pattern');
const confEl=document.getElementById('conf');
const nextRecEl=document.getElementById('nextRec');
const next3El=document.getElementById('next3');
const statsEl=document.getElementById('stats');
const logEl=document.getElementById('log');
const intervalInput=document.getElementById('intervalInput');

let acertos=0,erros=0,empates=0;
let lastRecommendation="‚Äî";
let autoRunning=false,autoTimer=null;

// Hist√≥rico e aprendizado
let history=[];
let weights={player:1,banker:1,tie:1};
let markov={player:{player:1,banker:1,tie:1}, banker:{player:1,banker:1,tie:1}, tie:{player:1,banker:1,tie:1}};

function resizeCanvas(w,h){canvas.width=w;canvas.height=h;overlay.width=w;overlay.height=h;}
function colorRole(r,g,b){if(r>170&&g<90&&b<90)return"banker";if(b>150&&r<100&&g<120)return"player";if(r>180&&g>180&&b<100)return"tie";return null;}

function detect(frame,w,h){
  const data=frame.data,points=[],step=6;
  for(let y=0;y<h;y+=step){for(let x=0;x<w;x+=step){const i=(y*w+x)*4;const role=colorRole(data[i],data[i+1],data[i+2]);if(role)points.push({x,y,role});}}
  const clusters=[];const dist=10;
  points.forEach(p=>{let f=clusters.find(c=>Math.hypot(c.x-p.x,c.y-p.y)<dist&&c.role===p.role);if(f){f.x=(f.x*f.n+p.x)/(f.n+1);f.y=(f.y*f.n+p.y)/(f.n+1);f.n++;}else clusters.push({x:p.x,y:p.y,role:p.role,n:1});});
  return clusters;
}

function analyze(blobs){
  const seq=blobs.map(b=>b.role);
  if(seq.length===0)return{name:"Sem padr√£o vis√≠vel",conf:0,freqs:{player:0,banker:0,tie:0}};
  const s=seq.join("-");
  let conf=0.5,name="Padr√£o neutro";
  if(/(player-){3,}/.test(s)){name="Dom√≠nio Player"; conf=0.92;}
  if(/(banker-){3,}/.test(s)){name="Dom√≠nio Banker"; conf=0.92;}
  if(seq.every((x,i,a)=>i===0||x!==a[i-1])){name="Altern√¢ncia"; conf=0.87;}
  if(seq.includes("tie")){name="Empates frequentes"; conf=0.7;}
  const freqs={player:0,banker:0,tie:0};
  seq.forEach((v,i)=>freqs[v]+=(1+(i/seq.length)));
  return {name:name,conf:conf,freqs:freqs,last:seq[seq.length-1]};
}

// Predi√ß√£o com Markov + pesos
function predictNext(last,freqs){
  let combined={player:weights.player*freqs.player,banker:weights.banker*freqs.banker,tie:weights.tie*freqs.tie};
  if(last && markov[last]){
    Object.keys(markov[last]).forEach(k=>{combined[k]+=markov[last][k]*0.7;});
  }
  let sorted=Object.entries(combined).sort((a,b)=>b[1]-a[1]);
  return {next:sorted[0][0],next3:sorted.slice(0,3)};
}

function updateMarkov(prev,next){
  if(prev){markov[prev][next]=(markov[prev][next]||1)+1;}
}

function updateStats(){
  const total=acertos+erros+empates;
  const perc=total?Math.round(acertos/total*100):0;
  statsEl.innerText=`Hist√≥rico: ${acertos} acertos / ${erros} erros / ${empates} empates (${perc}%)`;
}

function registrar(tipo){
  if(tipo==="acerto"){acertos++; weights[lastRecommendation]+=1;}
  if(tipo==="erro"){erros++; weights[lastRecommendation]=Math.max(1,weights[lastRecommendation]-1);}
  if(tipo==="empate"){empates++; weights["tie"]+=1;}
  updateStats(); analyzeCurrentImage();
}

function drawOverlay(blobs){
  octx.clearRect(0,0,overlay.width,overlay.height);
  blobs.forEach(b=>{octx.beginPath();octx.arc(b.x,b.y,8,0,Math.PI*2);octx.strokeStyle=b.role==="player"?"#00ffc3":b.role==="banker"?"#ff3366":"#ffff66";octx.lineWidth=2;octx.stroke();});
}

function log(msg){const t=new Date().toLocaleTimeString();logEl.innerHTML=`[${t}] ${msg}<br>`+logEl.innerHTML;}

let lastDetected=null;

function analyzeCurrentImage(){
  if(!canvas.width)return;
  const frame=ctx.getImageData(0,0,canvas.width,canvas.height);
  const blobs=detect(frame,canvas.width,canvas.height);
  drawOverlay(blobs);
  
  const analysis=analyze(blobs);
  patternEl.innerText=analysis.name;
  confEl.innerText=Math.round(analysis.conf*100)+"%";
  
  const prediction=predictNext(analysis.last,analysis.freqs);
  nextRecEl.innerText=prediction.next==="player"?"üîµ Player":prediction.next==="banker"?"üî¥ Banker":"üü° Empate";
  next3El.innerText=prediction.next3.map(x=>x[0]==="player"?"üîµ":x[0]==="banker"?"üî¥":"üü°").join(" | ");
  
  if(lastDetected)updateMarkov(lastDetected,analysis.last);
  lastDetected=analysis.last;
  
  lastRecommendation=prediction.next;
  history.push({timestamp:Date.now(),pattern:analysis.name,recommendation:prediction.next});
  
  log(`Padr√£o: ${analysis.name} | Pr√≥ximo: ${prediction.next} | Top3: ${prediction.next3.map(x=>x[0]).join(", ")}`);
  statusEl.innerText="Analisando imagem...";
}

function startAutoAnalysis(){
  if(autoRunning)return;
  const interval=Number(intervalInput.value)*1000;
  autoTimer=setInterval(()=>{analyzeCurrentImage();},interval);
  autoRunning=true;
  statusEl.innerText=`An√°lise cont√≠nua ativa (${interval/1000}s)`;
  log("An√°lise cont√≠nua iniciada.");
}

function stopAutoAnalysis(){if(autoTimer){clearInterval(autoTimer);} autoRunning=false; statusEl.innerText="Parado"; log("An√°lise cont√≠nua parada.");}

// Eventos
document.getElementById('sendImg').onclick=()=>{
  const input=document.createElement('input'); input.type='file'; input.accept='image/*';
  input.onchange=e=>{
    const file=e.target.files[0]; if(!file)return;
    const img=new Image(); img.onload=()=>{
      resizeCanvas(img.width,img.height); ctx.drawImage(img,0,0,canvas.width,canvas.height); analyzeCurrentImage();
    };
    img.src=URL.createObjectURL(file);
  };
  input.click();
};

document.getElementById('btnAcertou').onclick=()=>registrar("acerto");
document.getElementById('btnErrou').onclick=()=>registrar("erro");
document.getElementById('btnEmpate').onclick=()=>registrar("empate");
document.getElementById('toggleAuto').onclick=()=>autoRunning?stopAutoAnalysis():startAutoAnalysis();
document.getElementById('stopBtn').onclick=stopAutoAnalysis;
</script>
</body>
</html>
