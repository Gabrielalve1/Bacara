<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Baccarat Mobile Vision – Simulado</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { background:#000; color:#fff; font-family:Arial,sans-serif; text-align:center; padding:10px; }
  h1 { color:#00ffc3; margin:10px 0; }
  #controls { margin-bottom:10px; }
  button { margin:5px; padding:10px 15px; border:none; border-radius:6px; background:#00ffc3; color:#000; font-weight:bold; cursor:pointer; }
  #videoCanvas { width:100%; max-width:480px; border:2px solid #111; border-radius:8px; }
  #output { margin-top:10px; padding:10px; background:#111; border-radius:8px; max-height:300px; overflow-y:auto; text-align:left; font-size:16px; }
  .player { color:#00ffc3; font-weight:bold; }
  .banker { color:#ff3366; font-weight:bold; }
  .tie { color:#ffff33; font-weight:bold; }
  #warning { color:#ffcc00; font-weight:bold; margin-top:6px; }
</style>
</head>
<body>

<h1>🔮 Baccarat Mobile Vision</h1>

<div id="controls">
  <button id="startCam">▶ Iniciar Câmera</button>
  <button id="stopCam">■ Parar</button>
</div>

<canvas id="videoCanvas"></canvas>

<div id="output">Aguardando análise...</div>
<div id="warning"></div>

<script>
const videoCanvas = document.getElementById('videoCanvas');
const ctx = videoCanvas.getContext('2d');
let video = document.createElement('video');
video.autoplay = true;
video.playsInline = true;

let stream = null;
let running = false;

// Histórico e pesos adaptativos
let historico = [];
let pesos = {player:1, banker:1, tie:1};

// Estratégias simples do ebook
const estrategias = ["Gale","Reversão","Empate Inteligente","Torres Gêmeas","3-1-3","2-2 Escada","Quinta Casa"];

// Utilitário para fala
function speak(text){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'pt-BR';
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

// Detecta cor da bolinha
function colorToRole(r,g,b){
  if(r>150 && g<100 && b<100) return 'banker';
  if(r<100 && g<100 && b>150) return 'player';
  if(r>180 && g>180 && b<120) return 'tie';
  return null;
}

// Processa frame e retorna sequência
function processFrame(){
  const w = videoCanvas.width;
  const h = videoCanvas.height;
  ctx.drawImage(video,0,0,w,h);
  const data = ctx.getImageData(0,0,w,h).data;
  const seq = [];
  const step = 5;
  for(let y=0;y<h;y+=step){
    for(let x=0;x<w;x+=step){
      const i = (y*w+x)*4;
      const r = data[i], g = data[i+1], b = data[i+2];
      const role = colorToRole(r,g,b);
      if(role && (!seq.length || seq[seq.length-1] !== role)) seq.push(role);
    }
  }
  return seq;
}

// Escolhe estratégia baseada em última rodada
function escolherEstrategia(atual){
  if(historico.length && historico[historico.length-1].resultado==='erro') return "Gale";
  if(atual==='tie') return "Empate Inteligente";
  let r = Math.random();
  if(r < pesos.player) return "3-1-3";
  if(r < pesos.player + pesos.banker) return "Torres Gêmeas";
  return "Reversão";
}

// Loop de análise
function loop(){
  if(!running) return;
  const seq = processFrame();
  if(seq.length===0){
    document.getElementById('warning').innerText = '⚠️ Imagem ruim para leitura!';
  } else {
    document.getElementById('warning').innerText = '';
    const atual = seq[seq.length-1];
    const estrategia = escolherEstrategia(atual);
    document.getElementById('output').innerHTML = `Último: <span class='${atual}'>${atual}</span><br>Recomendação: <b>${estrategia}</b><br>Sequência: ${seq.join(', ')}`;
    speak(`Último: ${atual}. Estratégia recomendada: ${estrategia}`);
  }
  requestAnimationFrame(loop);
}

// Start e Stop
document.getElementById('startCam').onclick = async ()=>{
  if(stream) stopCam();
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:true});
    video.srcObject = stream;
    video.onloadedmetadata = ()=>{ 
      video.play();
      videoCanvas.width = video.videoWidth;
      videoCanvas.height = video.videoHeight;
      running = true;
      loop();
    };
  }catch(e){
    alert('Erro ao acessar câmera: '+e.message);
  }
};

function stopCam(){
  running = false;
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }
}

document.getElementById('stopCam').onclick = stopCam;

</script>
</body>
</html>
