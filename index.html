<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Baccarat Reader ‚Äì Estrat√©gico</title>
<style>
  body{margin:0;background:#0b1419;color:#e9f9f3;font-family:Arial,Helvetica,sans-serif;display:flex;flex-direction:column;align-items:center;padding:12px}
  h1{color:#00ffc3}
  #controls{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;justify-content:center}
  button,input{border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-size:14px}
  button{background:#00ffc3;color:#000;font-weight:bold}
  button.alt{background:#1a2426;color:#fff}
  #canvasWrap{position:relative;width:90%;max-width:920px}
  canvas,img{width:100%;border-radius:10px}
  #overlay{position:absolute;top:0;left:0;pointer-events:none}
  #panel{width:90%;max-width:920px;margin-top:10px;background:#0d171c;padding:12px;border-radius:10px}
  #warning{color:#ffcc00;font-weight:700;margin-top:8px}
  #results{display:flex;gap:8px;margin-top:8px;justify-content:center}
  #stats{margin-top:8px;font-size:15px;text-align:center;color:#00ffc3}
</style>
</head>
<body>
<h1>üîé Baccarat Reader (Pro Estrat√©gico)</h1>

<div id="controls">
  <button id="startCam" class="alt">üì∑ C√¢mera</button>
  <button id="sendImg" class="alt">üì∏ Enviar Foto</button>
  <button id="stopBtn" class="alt">‚õî Parar</button>
</div>

<div id="canvasWrap">
  <canvas id="canvas"></canvas>
  <canvas id="overlay"></canvas>
</div>

<div id="panel">
  <div><b>Status:</b> <span id="status">Parado</span></div>
  <div><b>Recomenda√ß√£o:</b> <span id="pattern">‚Äî</span></div>
  <div><b>Confian√ßa:</b> <span id="conf">0%</span></div>

  <div id="results">
    <button id="btnAcertou" style="background:#00ff66">‚úÖ Acertou</button>
    <button id="btnErrou" style="background:#ff3366">‚ùå Errou</button>
    <button id="btnEmpate" style="background:#ffcc00">‚öñÔ∏è Empatou</button>
  </div>

  <div id="stats">Hist√≥rico: 0 acertos / 0 erros / 0 empates (0%)</div>
  <div id="warning"></div>
</div>

<script>
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const overlay=document.getElementById('overlay');
const octx=overlay.getContext('2d');
const statusEl=document.getElementById('status');
const patternEl=document.getElementById('pattern');
const confEl=document.getElementById('conf');
const statsEl=document.getElementById('stats');
const warningEl=document.getElementById('warning');

let video=document.createElement('video');
video.autoplay=true; video.playsInline=true;
let stream=null; let running=false;

let sequenceHistory=[],feedbackHistory=[];
let weights={player:1,banker:1,tie:1};
let acertos=0,erros=0,empates=0;

function resizeCanvas(w,h){canvas.width=w;canvas.height=h;overlay.width=w;overlay.height=h;}

function colorRole(r,g,b){
  if(r>170&&g<80&&b<80) return "banker";
  if(b>150&&r<80&&g<100) return "player";
  if(r>180&&g>180&&b<140) return "tie";
  return null;
}

function detect(frame,w,h){
  const data=frame.data,step=5;
  const pts=[];
  for(let y=0;y<h;y+=step){
    for(let x=0;x<w;x+=step){
      const i=(y*w+x)*4;
      const r=data[i],g=data[i+1],b=data[i+2];
      const role=colorRole(r,g,b);
      if(role) pts.push({x,y,role});
    }
  }
  const clusters=[];
  const dist=10;
  pts.forEach(p=>{
    let f=clusters.find(c=>Math.hypot(c.x-p.x,c.y-p.y)<dist && c.role===p.role);
    if(f){f.x=(f.x*f.n+p.x)/(f.n+1); f.y=(f.y*f.n+p.y)/(f.n+1); f.n++;} 
    else clusters.push({x:p.x,y:p.y,role:p.role,n:1});
  });
  return clusters;
}

function drawOverlay(blobs){
  octx.clearRect(0,0,overlay.width,overlay.height);
  blobs.forEach(b=>{
    octx.beginPath();
    octx.arc(b.x,b.y,8,0,Math.PI*2);
    octx.strokeStyle=b.role==="player"?"#00ffc3":b.role==="banker"?"#ff3366":"#ffff66";
    octx.lineWidth=2; octx.stroke();
  });
}

function analyze(blobs){
  const seq=blobs.map(b=>b.role);
  if(seq.length===0) return {recommendation:"player", confidence:0.5, explanation:"Sem dados"};

  const counts={player:0,banker:0,tie:0};
  seq.forEach(r=>counts[r]++);
  sequenceHistory=seq;

  // streak detection
  let last=seq[seq.length-1],streak=1;
  for(let i=seq.length-2;i>=0;i--){
    if(seq[i]===last) streak++; else break;
  }

  // zig-zag detection
  let zigzag=true;
  for(let i=1;i<seq.length;i++){ if(seq[i]===seq[i-1]) zigzag=false; }

  let rec="player",conf=0.5;
  if(streak>=3){ rec=last; conf=0.8; }
  else if(zigzag){ rec=seq[seq.length-1]==="player"?"banker":"player"; conf=0.75; }
  else {
    let max=0;
    for(const k of ["player","banker","tie"]){
      const val=counts[k]*weights[k];
      if(val>max){max=val; rec=k; max=val; }
    }
    conf=Math.min(0.99, Math.max(0.3, max/seq.length));
  }

  // feedback adjustment
  conf=conf*(1+0.05*feedbackHistory.filter(f=>f==="acerto").length);

  return {recommendation:rec, confidence:conf, explanation:`streak=${streak}, zigzag=${zigzag}, counts=${JSON.stringify(counts)}, weights=${JSON.stringify(weights)}`};
}

function speak(txt){
  if(!("speechSynthesis" in window)) return;
  const u=new SpeechSynthesisUtterance(txt); u.lang="pt-BR"; speechSynthesis.cancel(); speechSynthesis.speak(u);
}

function runFrame(){
  if(!running) return;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const frame=ctx.getImageData(0,0,canvas.width,canvas.height);
  const blobs=detect(frame,canvas.width,canvas.height);
  drawOverlay(blobs);

  const result=analyze(blobs);
  patternEl.innerText=result.recommendation;
  confEl.innerText=Math.round(result.confidence*100)+"%";
  statusEl.innerText="Analisando gr√°fico";
  requestAnimationFrame(runFrame);
}

function atualizarStats(){
  const total=acertos+erros+empates;
  const perc=total?Math.round((acertos/total)*100):0;
  statsEl.innerText=`Hist√≥rico: ${acertos} acertos / ${erros} erros / ${empates} empates (${perc}%)`;
}

function registrar(tipo){
  if(tipo==="acerto"){ acertos++; feedbackHistory.push("acerto"); }
  if(tipo==="erro"){ erros++; feedbackHistory.push("erro"); }
  if(tipo==="empate"){ empates++; feedbackHistory.push("empate"); }
  atualizarStats();
  // imediata nova recomenda√ß√£o
  const result=analyze({map:()=>{}...sequenceHistory.map(r=>({role:r}))});
  patternEl.innerText=result.recommendation;
  confEl.innerText=Math.round(result.confidence*100)+"%";
  speak(`Nova recomenda√ß√£o: ${result.recommendation}, confian√ßa ${Math.round(result.confidence*100)}%`);
}

async function startCam(){
  try{
    stopAll();
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject=stream;
    video.onloadedmetadata=()=>{
      resizeCanvas(video.videoWidth,video.videoHeight);
      running=true;
      statusEl.innerText="C√¢mera ativa";
      runFrame();
    };
  }catch(e){alert(e);}
}

function stopAll(){
  running=false; statusEl.innerText="Parado";
  if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;}
  octx.clearRect(0,0,overlay.width,overlay.height);
}

document.getElementById('startCam').onclick=startCam;
document.getElementById('stopBtn').onclick=stopAll;
document.getElementById('btnAcertou').onclick=()=>registrar("acerto");
document.getElementById('btnErrou').onclick=()=>registrar("erro");
document.getElementById('btnEmpate').onclick=()=>registrar("empate");

document.getElementById('sendImg').onclick=()=>{
  const input=document.createElement('input'); input.type='file'; input.accept='image/*';
  input.onchange=e=>{
    const file=e.target.files[0]; if(!file) return;
    const img=new Image();
    img.onload=()=>{
      resizeCanvas(img.width,img.height);
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      const frame=ctx.getImageData(0,0,canvas.width,canvas.height);
      const blobs=detect(frame,canvas.width,canvas.height);
      drawOverlay(blobs);
      const result=analyze(blobs);
      patternEl.innerText=result.recommendation;
      confEl.innerText=Math.round(result.confidence*100)+"%";
      statusEl.innerText="Imagem analisada";
      speak(`Recomenda√ß√£o: ${result.recommendation}, confian√ßa ${Math.round(result.confidence*100)}%`);
    };
    img.src=URL.createObjectURL(file);
  };
  input.click();
};
</script>
</body>
</html>
